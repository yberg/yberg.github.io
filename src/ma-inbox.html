<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-meta/iron-meta.html"><link rel="import" href="../bower_components/iron-list/iron-list.html"><link rel="import" href="../bower_components/paper-ripple/paper-ripple.html"><link rel="import" href="../bower_components/paper-item/paper-icon-item.html"><link rel="import" href="../bower_components/paper-item/paper-item-body.html"><link rel="import" href="../bower_components/polymerfire/firebase-auth-script.html"><link rel="import" href="../bower_components/polymerfire/firebase-database-script.html"><link rel="import" href="ma-header-layout.html"><link rel="import" href="ma-spinner.html"><link rel="import" href="ma-chat.html"><link rel="import" href="ma-icons.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="ma-inbox"><template><style include="shared-styles">iron-list{height:calc(100vh - 96px);padding:16px 0;}.paper-item-link{color:inherit;text-decoration:none;}paper-item{background:white;border:1px solid #ddd;border-width:1px 0px;margin-top:-1px;}.item:last-child, .item.last{border-bottom:1px solid #ddd;}</style><iron-meta key="env" value="{{env}}"></iron-meta><app-localstorage-document key="auth" data="{{auth}}"></app-localstorage-document><app-localstorage-document key="user" data="{{user}}"></app-localstorage-document><app-route route="{{route}}" pattern="/:id" data="{{routeData}}" tail="{{subroute}}"></app-route><iron-ajax auto="" url="[[env.apiUrl]]/Messaging/GetUserToken?auth=[[auth]]" method="post" content-type="application/x-www-form-urlencoded" handle-as="json" on-response="_handleUserTokenResponse"></iron-ajax><ma-spinner loading="[[loading]]"></ma-spinner><ma-header-layout fullbleed="" title="[[title]]" fixed="" shadow="" back-button$="[[_has(routeData.id)]]"><div class="condense"><template is="dom-if" if="[[!routeData.id]]"><iron-list items="[[chats]]" as="chat"><template><a href="[[rootPath]]inbox/[[chat.FrPId]]" class="paper-item-link"><paper-icon-item><iron-icon icon="ma-icons:chat" slot="item-icon"></iron-icon><paper-item-body two-line=""><div>[[chat.FrPNameDen]]</div><div secondary="">[[chat.Msg]]</div></paper-item-body><paper-ripple></paper-ripple></paper-icon-item></a></template></iron-list></template><template is="dom-if" if="[[routeData.id]]"><ma-chat chat="[[activeChat]]"></ma-chat></template></div></ma-header-layout></template><script>class MaInbox extends Polymer.Element{static get is(){return'ma-inbox'}static get properties(){return{idToken:String,refreshToken:String,user:Object,safeId:{type:String,computed:'_computeSafeId(user)'},messages:{type:Array,value:()=>[]},chats:{type:Array,computed:'_computeChats(messages)'},activeChat:{type:Array,computed:'_computeActiveChat(messages, routeData.id)'},title:{type:String,computed:'_computeTitle(routeData.id, activeChat)'},loading:{type:Boolean,value:!0}}}static get observers(){return['_routeChanged(route, subroute)']}_routeChanged(a){if('/inbox'===a.prefix){const b=+a.path.replace('/','');this.set('routeData.id',b)}}_computeSafeId(a){return a&&a.owningUserId?btoa(a.owningUserId):null}_computeChats(a){const b=Object.assign([],a);return b.reverse().filter((a,c)=>b.findIndex((b)=>b.FrPNameDen===a.FrPNameDen)===c)}_computeActiveChat(a,b){return b?a.filter((a)=>a.FrPId===b):a}_computeTitle(a,b){return a?(b.find((b)=>b.FrPId===a)||{}).FrPNameDen:'Meddelanden'}_handleUserTokenResponse(a){const b=a.detail.response;if(b.Success){firebase.auth().signInWithCustomToken(b.Token);const a=firebase.database();a.ref(`/chats/${this.safeId}`).on('value',(a)=>{const b=a.val(),c=Object.keys(b).map((a)=>Object.assign(b[a],{key:a}));console.log('messages',c),this.set('messages',c),this.set('loading',!1)})}}_has(a){return!!a}}window.customElements.define(MaInbox.is,MaInbox);</script></dom-module></body></html>