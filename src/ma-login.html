<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-meta/iron-meta.html"><link rel="import" href="../bower_components/iron-icon/iron-icon.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="ma-storage.html"><link rel="import" href="ma-header-layout.html"><link rel="import" href="ma-spinner.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="ma-login"><template><style include="shared-styles">:host{--paper-button:{background:var(--app-primary-color);color:white;};}.wrapper{@apply --layout-vertical;justify-content:center;align-items:center;height:100%;margin:0 32px;}.wrapper > *{width:100%;margin-top:16px;}ma-header-layout{--ma-header-background-color:transparent;--ma-header-background-rear-color:rgba(255, 255, 255, .75);--ma-header-foreground-color:var(--app-primary-color);}</style><iron-meta key="env" value="{{env}}"></iron-meta><app-localstorage-document key="user" data="{{user}}"></app-localstorage-document><app-localstorage-document key="auth" data="{{auth}}"></app-localstorage-document><iron-ajax id="createAccountRequest" url="[[env.apiUrl]]/Client/CreateAccountConfirmedEmail" method="post" content-type="application/x-www-form-urlencoded" handle-as="json" on-response="_handleCreateAccountResponse"></iron-ajax><iron-ajax id="verifyAccountRequest" url="[[env.apiUrl]]/Client/VerifyAccountConfirmedEmail" method="post" content-type="application/x-www-form-urlencoded" handle-as="json" on-response="_handleVerifyAccountResponse"></iron-ajax><iron-ajax id="loginRequest" url="[[env.apiUrl]]/Client/LogOnConfirmedEmail" method="post" content-type="application/x-www-form-urlencoded" handle-as="json" on-response="_handleLoginResponse"></iron-ajax><iron-ajax id="participantInfoRequest" url="[[env.apiUrl]]/Participant/GetMyParticipantInfo?auth=[[auth]]" handle-as="json" on-response="_handleParticipantInfoResponse"></iron-ajax><ma-spinner overlay="" loading="[[loading]]"></ma-spinner><ma-header-layout title="Logga in" effects="waterfall fade-background" reveals="" no-menu-button=""><div class="wrapper condense"><paper-input id="email" type="email" label="E-postadress" value="{{email}}" auto-validate="" disabled$="[[accountCreated]]"></paper-input><paper-button raised="" on-tap="_createAccount" disabled$="[[accountCreated]]">NÃ¤sta</paper-button><template is="dom-if" if="[[accountCreated]]"><h3>Ange kod</h3><paper-input type="number" label="Kod" value="{{code}}" disabled$="[[accountVerified]]"></paper-input><paper-button raised="" on-tap="_verifyAccount" disabled$="[[accountVerified]]">Logga in</paper-button></template></div></ma-header-layout></template><script>class MaLogin extends Polymer.Element{static get is(){return'ma-login'}static get properties(){return{accountCreated:Boolean,accountVerified:Boolean,loading:Boolean,user:{type:Object,value:()=>({})},auth:{type:String,value:''}}}_initializeUser(){this.user={}}_userLoaded(a){console.log(a),console.log('user',this.user)}_createAccount(){const a=this.$.email;a.value&&a.validate()&&(this.set('loading',!0),this.phoneId=(Math.floor(1e4*Math.random()+1)+'').padStart(4,'0'),this.$.createAccountRequest.body={appId:this.env.appId,email:this.email,phoneId:this.phoneId,firstname:'Viktor',lastname:'Yberg'},this.$.createAccountRequest.generateRequest())}_handleCreateAccountResponse(a){this.set('loading',!1);const b=a.detail.response;b.Success&&this.set('accountCreated',!0)}_verifyAccount(){this.set('loading',!0),this.$.verifyAccountRequest.body={appId:this.env.appId,email:this.email,phoneId:this.phoneId,code:this.code},this.$.verifyAccountRequest.generateRequest()}_handleVerifyAccountResponse(a){this.set('loading',!1);const b=a.detail.response;console.log('res',b),b.Success&&(this.set('accountVerified',!0),this.login(this.email,b.Password))}login(a,b){this.set('loading',!0),this.$.loginRequest.body={appId:this.env.appId,email:a,phoneId:this.phoneId,password:b},this.$.loginRequest.generateRequest()}_handleLoginResponse(a){this.set('loading',!1);const b=a.detail.response;b.Valid&&(this.set('user.email',this.email),this.set('auth',b.SessionIdentifier),this._getParticipantInfo())}_getParticipantInfo(){this.$.participantInfoRequest.generateRequest()}_handleParticipantInfoResponse(a){const b=a.detail.response;this.set('user.id',b.Id),this.set('user.firstName',b.FirstName),this.set('user.lastName',b.LastName),this.set('user.owningUserId',b.OwningUserId),window.dispatchEvent(new CustomEvent('user-logged-in',{detail:{user:this.user}}))}}window.customElements.define(MaLogin.is,MaLogin);</script></dom-module></body></html>